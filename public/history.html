<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>K6 Load Testing - Test History</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px 0;
    }
    .main-container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      padding: 30px;
      margin: 20px auto;
      max-width: 1400px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 3px solid #667eea;
    }
    .header h1 {
      color: #667eea;
      font-weight: bold;
      margin: 0;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    .filters-section {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 25px;
    }
    .search-box {
      position: relative;
    }
    .search-box i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #6c757d;
    }
    .search-box input {
      padding-left: 40px;
    }
    .stats-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
    }
    .stats-card .number {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .stats-card .label {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    .test-row {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
      transition: all 0.3s;
      cursor: pointer;
    }
    .test-row:hover {
      border-color: #667eea;
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
      transform: translateY(-2px);
    }
    .test-row.expanded {
      border-color: #667eea;
      background: #f8f9ff;
    }
    .test-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .test-title {
      display: flex;
      align-items: center;
      gap: 15px;
      flex: 1;
    }
    .test-title h5 {
      margin: 0;
      color: #333;
      font-weight: 600;
    }
    .test-title .url {
      color: #6c757d;
      font-size: 0.9rem;
      font-family: monospace;
    }
    .test-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .status-badge {
      padding: 6px 15px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .badge-success {
      background: #d4edda;
      color: #155724;
    }
    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }
    .badge-danger {
      background: #f8d7da;
      color: #721c24;
    }
    .test-meta {
      display: flex;
      gap: 25px;
      margin-top: 10px;
      font-size: 0.9rem;
      color: #6c757d;
    }
    .test-meta-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .test-details {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid #e0e0e0;
      display: none;
    }
    .test-details.show {
      display: block;
    }
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .metric-card {
      background: #f8f9fa;
      border-left: 4px solid #667eea;
      padding: 15px;
      border-radius: 5px;
    }
    .metric-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #667eea;
    }
    .metric-label {
      font-size: 0.85rem;
      color: #6c757d;
      margin-top: 5px;
    }
    .status-codes-grid {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    .status-code-badge {
      padding: 8px 15px;
      border-radius: 5px;
      font-size: 0.9rem;
      font-weight: 600;
    }
    .status-2xx { background: #d4edda; color: #155724; }
    .status-4xx { background: #fff3cd; color: #856404; }
    .status-5xx { background: #f8d7da; color: #721c24; }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6c757d;
    }
    .empty-state i {
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.5;
    }
    .loading {
      text-align: center;
      padding: 40px;
    }
    .method-badge {
      padding: 4px 10px;
      border-radius: 5px;
      font-size: 0.8rem;
      font-weight: 600;
      font-family: monospace;
    }
    .method-GET { background: #d1ecf1; color: #0c5460; }
    .method-POST { background: #d4edda; color: #155724; }
    .method-PUT { background: #fff3cd; color: #856404; }
    .method-DELETE { background: #f8d7da; color: #721c24; }
    .method-PATCH { background: #e2e3e5; color: #383d41; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="main-container">
      <div class="header">
        <div>
          <h1><i class="bi bi-clock-history"></i> Test History</h1>
          <p class="text-muted mb-0">View and manage all your past load tests</p>
        </div>
        <div>
          <button class="btn btn-primary" onclick="goToNewTest()">
            <i class="bi bi-house"></i> Home
          </button>
          <button class="btn btn-outline-secondary me-2" onclick="refreshHistory()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
          </button>
        </div>
      </div>

      <!-- Statistics -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="stats-card">
            <div class="number" id="totalTests">0</div>
            <div class="label">Total Tests</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
            <div class="number" id="successfulTests">0</div>
            <div class="label">Successful</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <div class="number" id="failedTests">0</div>
            <div class="label">Failed</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <div class="number" id="avgResponseTime">0</div>
            <div class="label">Avg Response (ms)</div>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="filters-section">
        <div class="row g-3">
          <div class="col-md-5">
            <div class="search-box">
              <i class="bi bi-search"></i>
              <input type="text" class="form-control" id="searchInput" placeholder="Search by test name, URL, or test ID...">
            </div>
          </div>
          <div class="col-md-2">
            <select class="form-select" id="statusFilter">
              <option value="">All Statuses</option>
              <option value="completed">Completed</option>
              <option value="failed">Failed</option>
            </select>
          </div>
          <div class="col-md-2">
            <select class="form-select" id="methodFilter">
              <option value="">All Methods</option>
              <option value="GET">GET</option>
              <option value="POST">POST</option>
              <option value="PUT">PUT</option>
              <option value="DELETE">DELETE</option>
              <option value="PATCH">PATCH</option>
            </select>
          </div>
          <div class="col-md-3">
            <select class="form-select" id="sortFilter">
              <option value="date-desc">Newest First</option>
              <option value="date-asc">Oldest First</option>
              <option value="duration-desc">Longest Duration</option>
              <option value="duration-asc">Shortest Duration</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Tests List -->
      <div id="testsList">
        <div class="loading">
          <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3 text-muted">Loading test history...</p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_URL = 'http://localhost:3000/api';
    let allTests = [];
    let filteredTests = [];

    // Load history on page load
    window.addEventListener('DOMContentLoaded', () => {
      loadHistory();
      setupFilters();
    });

    // Load test history
    async function loadHistory() {
      try {
        const response = await fetch(`${API_URL}/history`);
        const data = await response.json();
        
        if (data.success) {
          allTests = data.tests || [];
          filteredTests = [...allTests];
          updateStatistics();
          renderTests();
        } else {
          throw new Error(data.error || 'Failed to load history');
        }
      } catch (error) {
        document.getElementById('testsList').innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> Error loading test history: ${error.message}
          </div>
        `;
      }
    }

    // Update statistics
    function updateStatistics() {
      const total = allTests.length;
      const successful = allTests.filter(t => t.status === 'completed').length;
      const failed = allTests.filter(t => t.status === 'failed').length;
      
      let totalResponseTime = 0;
      let responseTimeCount = 0;
      
      allTests.forEach(test => {
        if (test.results && test.results.avgDuration) {
          totalResponseTime += parseFloat(test.results.avgDuration);
          responseTimeCount++;
        }
      });
      
      const avgResponseTime = responseTimeCount > 0 ? Math.round(totalResponseTime / responseTimeCount) : 0;
      
      document.getElementById('totalTests').textContent = total;
      document.getElementById('successfulTests').textContent = successful;
      document.getElementById('failedTests').textContent = failed;
      document.getElementById('avgResponseTime').textContent = avgResponseTime;
    }

    // Render tests
    function renderTests() {
      const testsList = document.getElementById('testsList');
      
      if (filteredTests.length === 0) {
        testsList.innerHTML = `
          <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <h4>No tests found</h4>
            <p>Try adjusting your filters or run a new test to get started.</p>
          </div>
        `;
        return;
      }

      testsList.innerHTML = filteredTests.map(test => renderTestRow(test)).join('');
    }

    // Render individual test row
    function renderTestRow(test) {
      const statusBadgeClass = test.status === 'completed' ? 'badge-success' : 
                              test.status === 'failed' ? 'badge-danger' : 'badge-warning';
      const statusText = test.status === 'completed' ? 'Completed' : 
                        test.status === 'failed' ? 'Failed' : 'Unknown';
      
      const date = new Date(test.timestamp || test.startTime);
      const dateStr = date.toLocaleString();
      
      const duration = test.config ? test.config.duration : 'N/A';
      const vus = test.config ? test.config.vus : 'N/A';
      
      let detailsHtml = '';
      
      if (test.results) {
        const r = test.results;
        detailsHtml = `
          <div class="test-details" id="details-${test.testId}">
            <div class="metrics-grid">
              <div class="metric-card">
                <div class="metric-value">${r.totalRequests || 0}</div>
                <div class="metric-label">Total Requests</div>
              </div>
              <div class="metric-card">
                <div class="metric-value">${r.avgDuration || 0}</div>
                <div class="metric-label">Avg Duration (ms)</div>
              </div>
              <div class="metric-card">
                <div class="metric-value">${r.minDuration || 0}</div>
                <div class="metric-label">Min Duration (ms)</div>
              </div>
              <div class="metric-card">
                <div class="metric-value">${r.maxDuration || 0}</div>
                <div class="metric-label">Max Duration (ms)</div>
              </div>
              <div class="metric-card">
                <div class="metric-value">${r.p50 || 0}</div>
                <div class="metric-label">P50 (ms)</div>
              </div>
              <div class="metric-card">
                <div class="metric-value">${r.p95 || 0}</div>
                <div class="metric-label">P95 (ms)</div>
              </div>
              <div class="metric-card">
                <div class="metric-value">${r.p99 || 0}</div>
                <div class="metric-label">P99 (ms)</div>
              </div>
            </div>
            
            ${r.statusCodes ? `
              <h6 class="mb-2"><i class="bi bi-bar-chart"></i> HTTP Status Codes</h6>
              <div class="status-codes-grid">
                ${Object.entries(r.statusCodes).map(([code, count]) => {
                  const statusClass = code.startsWith('2') ? 'status-2xx' : 
                                     code.startsWith('4') ? 'status-4xx' : 
                                     code.startsWith('5') ? 'status-5xx' : '';
                  return `<span class="status-code-badge ${statusClass}">${code}: ${count}</span>`;
                }).join('')}
              </div>
            ` : ''}
            
            <div class="mt-3">
              <button class="btn btn-success btn-sm" onclick="downloadReport('${test.testId}')">
                <i class="bi bi-download"></i> Download Report
              </button>
              <button class="btn btn-outline-danger btn-sm ms-2" onclick="deleteTest('${test.testId}')">
                <i class="bi bi-trash"></i> Delete
              </button>
            </div>
          </div>
        `;
      } else if (test.status === 'failed') {
        detailsHtml = `
          <div class="test-details" id="details-${test.testId}">
            <div class="alert alert-danger mb-3">
              <i class="bi bi-exclamation-triangle"></i> This test failed or timed out
            </div>
            <button class="btn btn-outline-danger btn-sm" onclick="deleteTest('${test.testId}')">
              <i class="bi bi-trash"></i> Delete
            </button>
          </div>
        `;
      }

      return `
        <div class="test-row" id="row-${test.testId}">
          <div class="test-header" onclick="toggleTestDetails('${test.testId}')">
            <div class="test-title">
              <div>
                <h6>
                  <span class="method-badge method-${test.config?.method || 'GET'}">${test.config?.method || 'GET'}</span>
                  ${test.name || 'Unnamed Test'}
                </h6>
                <div class="url">${test.config?.url || 'No URL'}</div>
              </div>
            </div>
            <div class="test-actions">
              <span class="status-badge ${statusBadgeClass}">${statusText}</span>
              <i class="bi bi-chevron-down" id="icon-${test.testId}"></i>
            </div>
          </div>
          
          <div class="test-meta">
            <div class="test-meta-item">
              <i class="bi bi-calendar"></i>
              <span>${dateStr}</span>
            </div>
            <div class="test-meta-item">
              <i class="bi bi-people"></i>
              <span>${vus} VUs</span>
            </div>
            <div class="test-meta-item">
              <i class="bi bi-clock"></i>
              <span>${duration}</span>
            </div>
            <div class="test-meta-item">
              <i class="bi bi-hash"></i>
              <span>${test.testId}</span>
            </div>
          </div>
          
          ${detailsHtml}
        </div>
      `;
    }

    // Toggle test details
    function toggleTestDetails(testId) {
      const details = document.getElementById(`details-${testId}`);
      const icon = document.getElementById(`icon-${testId}`);
      const row = document.getElementById(`row-${testId}`);
      
      if (details.classList.contains('show')) {
        details.classList.remove('show');
        icon.classList.remove('bi-chevron-up');
        icon.classList.add('bi-chevron-down');
        row.classList.remove('expanded');
      } else {
        details.classList.add('show');
        icon.classList.remove('bi-chevron-down');
        icon.classList.add('bi-chevron-up');
        row.classList.add('expanded');
      }
    }

    // Setup filters
    function setupFilters() {
      document.getElementById('searchInput').addEventListener('input', applyFilters);
      document.getElementById('statusFilter').addEventListener('change', applyFilters);
      document.getElementById('methodFilter').addEventListener('change', applyFilters);
      document.getElementById('sortFilter').addEventListener('change', applyFilters);
    }

    // Apply filters
    function applyFilters() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      const methodFilter = document.getElementById('methodFilter').value;
      const sortFilter = document.getElementById('sortFilter').value;
      
      // Filter
      filteredTests = allTests.filter(test => {
        const matchesSearch = !searchTerm || 
          (test.name && test.name.toLowerCase().includes(searchTerm)) ||
          (test.config?.url && test.config.url.toLowerCase().includes(searchTerm)) ||
          (test.testId && test.testId.toLowerCase().includes(searchTerm));
        
        const matchesStatus = !statusFilter || test.status === statusFilter;
        const matchesMethod = !methodFilter || test.config?.method === methodFilter;
        
        return matchesSearch && matchesStatus && matchesMethod;
      });
      
      // Sort
      filteredTests.sort((a, b) => {
        const aDate = new Date(a.timestamp || a.startTime);
        const bDate = new Date(b.timestamp || b.startTime);
        const aDuration = a.results?.avgDuration || 0;
        const bDuration = b.results?.avgDuration || 0;
        
        switch(sortFilter) {
          case 'date-desc': return bDate - aDate;
          case 'date-asc': return aDate - bDate;
          case 'duration-desc': return bDuration - aDuration;
          case 'duration-asc': return aDuration - bDuration;
          default: return bDate - aDate;
        }
      });
      
      renderTests();
    }

    // Download report
    function downloadReport(testId) {
      window.open(`${API_URL}/download/${testId}`, '_blank');
    }

    // Delete test
    async function deleteTest(testId) {
      if (!confirm('Are you sure you want to delete this test?')) return;
      
      try {
        const response = await fetch(`${API_URL}/delete/${testId}`, {
          method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
          allTests = allTests.filter(t => t.testId !== testId);
          applyFilters();
          updateStatistics();
        } else {
          alert('Failed to delete test: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        alert('Error deleting test: ' + error.message);
      }
    }

    // Refresh history
    function refreshHistory() {
      document.getElementById('testsList').innerHTML = `
        <div class="loading">
          <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3 text-muted">Loading test history...</p>
        </div>
      `;
      loadHistory();
    }

    // Go to new test
    function goToNewTest() {
      window.location.href = 'index.html';
    }

    // Make functions global
    window.toggleTestDetails = toggleTestDetails;
    window.downloadReport = downloadReport;
    window.deleteTest = deleteTest;
    window.refreshHistory = refreshHistory;
    window.goToNewTest = goToNewTest;
  </script>
</body>
</html>